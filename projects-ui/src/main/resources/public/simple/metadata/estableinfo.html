<link rel="stylesheet"  href="simple/metadata/tableinfo/tableinfo.css">
<div class="layui-card layadmin-header">
    <div class="layui-breadcrumb" lay-filter="breadcrumb">
        <a lay-href="">主页</a>
        <a><cite>应用</cite></a>
        <a><cite>分类管理</cite></a>
    </div>
</div>
<div class="layui-fluid">
    <div class="layui-col-md3 md2-left">
        <div class="layui-card h100">
            <div class="layui-card-header">
                <div class="layui-col-md3">ES元数据</div>
                <div class="icon-btn-bar layui-col-md9">
                    <span>
                        <button type="button" title="入库" class="layui-btn" onclick="saveToDb()">
                            <img src="common/img/u20774.svg">
                        </button>
                        <button type="button" title="新建连接" class="layui-btn" onclick="addEsLink()">
                            <img src="common/img/u20774.svg">
                        </button>
                        <button type="button" title="新建表" class="layui-btn" data-type="add">
                            <img src="common/img/u20039.svg">
                        </button>
                        <button type="button" title="克隆表" class="layui-btn" onclick="copyEsTable()">
                            <img src="common/img/u20041.svg">
                        </button>
                        <button type="button" title="删除表" class="layui-btn" data-type="del">
                            <img src="common/img/u20040.svg">
                        </button>
                        <!--                <div class="layui-btn-container">-->
                        <!--                    <button type="button" class="layui-btn layui-btn-sm" data-type="delCodes"><i class="layui-icon">&#xe640;</i>-->
                        <!--                        删除元数据表及代码应用-->
                        <!--                    </button>-->
                        <!--                </div>-->
                    </span>
                </div>
            </div>
            <div id="treeDemo" class="ztree" >
            </div>
        </div>
    </div>
<!--    <div class="layui-col-md3 jnet-left left-list">-->
<!--        <div class="layui-card h100">-->
<!--            <div class="layui-card-header">-->
<!--                <div class="layui-col-md3">ES索引</div>-->
<!--                <div class="icon-btn-bar layui-col-md9">-->
<!--                    <span>-->
<!--                        <button type="button" title="新建表" class="layui-btn" data-type="add">-->
<!--                            <img src="common/img/u20039.svg">-->
<!--                        </button>-->
<!--                        <button type="button" title="克隆表" class="layui-btn" data-type="edit">-->
<!--                            <img src="common/img/u20041.svg">-->
<!--                        </button>-->
<!--                        <button type="button" title="删除表" class="layui-btn" data-type="del">-->
<!--                            <img src="common/img/u20040.svg">-->
<!--                        </button>-->
<!--                        &lt;!&ndash;                <div class="layui-btn-container">&ndash;&gt;-->
<!--                        &lt;!&ndash;                    <button type="button" class="layui-btn layui-btn-sm" data-type="delCodes"><i class="layui-icon">&#xe640;</i>&ndash;&gt;-->
<!--                        &lt;!&ndash;                        删除元数据表及代码应用&ndash;&gt;-->
<!--                        &lt;!&ndash;                    </button>&ndash;&gt;-->
<!--                        &lt;!&ndash;                </div>&ndash;&gt;-->
<!--                    </span>-->
<!--                </div>-->
<!--            </div>-->
<!--            <div class="layui-card-header jnet-search-left">-->
<!--                <div class="layui-col-md11">-->
<!--                    <input type="text" id="searchTable" placeholder="请输入中文或英文名称" class="layui-input">-->
<!--                </div>-->
<!--                <div class="layui-col-md1">-->
<!--                    <button class="layui-btn layui-btn-sm" onclick="getMetadatas(1)"><img src="common/img/u11881.svg"></button>-->
<!--                </div>-->
<!--            </div>-->
<!--            <div class="layui-card-body jnet-left-body">-->
<!--                <form class="layui-form" id="listForm">-->
<!--                </form>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->
    <div class="layui-col-md9 md2-right h100">
        <div class="layui-card h100">
            <div class="layui-tab layui-tab-card h100" lay-filter="demo">
                <div class="layui-tab-content jnet-tab-content">
                    <div id="main" class="layui-tab-item layui-show" style="position: relative">
                        <div class="layui-card-header">表字段
                            <!--<input type="text" style="width: 200px;height: 30px" id="searchField" /><button onclick="doList(1)">sousou</button>--></div>
                        <div class="layui-card-body">
                            <div class="layui-btn-container">
                                <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" data-type="addEsField">
                                    添加字段
                                </button>
                                <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" data-type="createCodes">
                                    生成java代码
                                </button>
                                <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" data-type="mvJar">
                                    部署应用
                                </button>
                            </div>
                            <div class="table-area-mini">
                                <table class="layui-hide" id="fieldTabel" lay-filter="fieldTabel"></table>
                            </div>
                            <div id="fieldPage"></div>
                        </div>
                    </div>
                    <div class="layui-tab-item">
                        <div class="layui-card-header">git推送时间记录</div>
                        <div class="layui-card-body" style="height: 640px; overflow: auto;">
                            <table class="" id="fieldTable4" style="width: 100%;"></table>
                            <div id="fieldPage4"></div>
                        </div>
                    </div>
                </div>
                <ul class="layui-tab-title" id="manage">
                    <li class="layui-this" id="first">元数据字段</li>
                    <!--                    <li onclick="getPushTable()">git推送时间记录</li>-->
                </ul>
            </div>
        </div>
    </div>
    <form action="" class="layui-form" id="form1" style="display: none">
        <div class="layui-card">
            <div class="layui-card-body">
                <div class="layui-form-item">
                    <div class="layui-input-block"
                         style="margin: 20px 0 20px 20px; width: 80px; display: inline-block; height: 32px!important">
                        <select name="city" lay-verify="required">
                            <option value="">全部</option>
                        </select>
                    </div>
                    <div class="layui-input-block" style="margin: 20px -5px; width: 200px; display: inline-block;">
                        <input type="text" required lay-verify="required" placeholder="请输入检索词" autocomplete="off"
                               class="layui-input">
                    </div>
                    <div class="layui-input-block" style="margin: 20px 0px; display: inline-block;">
                        <button class="layui-btn"><i class="layui-icon layui-icon-search"></i></button>
                    </div>
                    <span style="font-size: 12px;float:right;margin: 40px 20px 0 0">共<span style="color: red">1</span>页,<span
                            style="color: red">43</span>个模块</span>
                </div>
                <div class="layui-form-item"
                     style="margin: 20px; border: 1px solid #ccc; height: 200px!important; overflow:auto">
                    <div class="layui-input-block"
                         style="margin: 7px; width: 200px; display: inline-block; height: 32px!important">
                        <input type="radio" name="sex"> <span>通用概览_标准化概况</span>
                    </div>
                    <div class="layui-input-block"
                         style="margin: 7px; width: 200px; display: inline-block; height: 32px!important">
                        <input type="radio" name="sex"><span>通用概览_标准化概况</span>
                    </div>
                    <div class="layui-input-block"
                         style="margin: 7px; width: 200px; display: inline-block; height: 32px!important">
                        <input type="radio" name="sex"><span>通用概览_标准化概况</span>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-input-block" style="margin-left: 135px;">
                        <button class="layui-btn" lay-submit lay-filter="formDemo">确定</button>
                        <button type="reset" class="layui-btn layui-btn-primary">取消</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
<!--弹出层模板（新增，查看，编辑）-->
<script type="text/html" id="metadataTemplate">
    <form class="layui-form" lay-filter="metadataForm">
        <div class="layui-card">
            <div class="layui-card-body">
                <div class="layui-form-item">
                    <label class="layui-form-label">*es地址:</label>
                    <div class="layui-input-block">
                        <select name="dbSourceId" lay-verify="required">
                            {{# layui.each(d.ps,function(index,item){ }}
                            <option value="{{item.id}}">{{item.name}}</option>
                            {{#}) }}
                        </select>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">*es表英文名称:</label>
                    <div class="layui-input-block">
                        <input type="text" name="index" value="" required lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-input-block" style="margin-left: 200px;">
                        <button class="layui-btn" lay-submit lay-filter="addMetadata">确认</button>
                        <button type="button" class="layui-btn layui-btn-primary" onclick="layer.closeAll();">取消
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</script>
<!--弹出层模板（新增，查看，编辑）-->
<script type="text/html" id="esLinkTpl">
    <form class="layui-form" lay-filter="esLinkForm">
        <div class="layui-card">
            <div class="layui-card-body">
                <div class="layui-form-item">
                    <label class="layui-form-label"><span style="color: red">*</span> 名称:</label>
                    <div class="layui-input-block">
                        <input type="text" name="name" required lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label"><span style="color: red">*</span> ip:</label>
                    <div class="layui-input-block">
                        <input type="text" name="ip" required lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label"><span style="color: red">*</span> 端口:</label>
                    <div class="layui-input-block">
                        <input type="text" name="port" required lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">账号:</label>
                    <div class="layui-input-block">
                        <input type="text" name="account" placeholder="请输入" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">密码:</label>
                    <div class="layui-input-block">
                        <input type="password" name="pw" placeholder="请输入" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-input-block" style="margin-left: 200px;">
                        <button class="layui-btn" lay-submit lay-filter="addDbSource">确认</button>
                        <button type="button" class="layui-btn layui-btn-primary" onclick="layer.closeAll();">取消
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <input type="hidden" name="id">
    </form>
</script>
<!--弹出层模板（新增，查看，编辑）-->
<script type="text/html" id="fieldTemplate">
    <form class="layui-form" lay-filter="fieldForm">
        <div class="layui-card">
            <div class="layui-card-body">
                <input type="hidden" name="dbSourceId" value="{{d.dbSourceId}}">
                <div class="layui-form-item">
                    <label class="layui-form-label">es表名</label>
                    <div class="layui-input-block">
                        <input type="text" placeholder="" readonly name="index" value="{{d.index}}" autocomplete="off"
                               class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">*中文名称</label>
                    <div class="layui-input-block">
                        <input type="text" name="anothername" class="layui-input" required lay-verify="required">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">*英文名称</label>
                    <div class="layui-input-block">
                        <input type="text" name="key" onfocusout="checkKeyword(this)" class="layui-input" required lay-verify="required">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">字段类型</label>
                    <div class="layui-input-block">
                        <select name="type" id="fieldtype" class="layui-input" lay-filter="fieldType">
                            <option value="text">text</option>
                            <option value="keyword">keyword</option>
                        </select>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-input-block" style="margin-left: 195px">
                        <button class="layui-btn" lay-submit="" lay-filter="addEsFieldinfo">立即提交</button>
                        <button type="button" class="layui-btn layui-btn-primary" onclick="layer.closeAll();">关闭
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</script>


<script type="text/html" id="leftItemTpl">
    {{#layui.each(d, function(index, item){}}
    <div class="layui-row jnet-left-item {{index==0?'active':''}}" data_id="{{item}}" data_name="{{item}}">
        <div class="layui-col-md1"><input type="radio" name="listid" value="{{item}}" lay-skin="primary" {{index==0?'checked':''}}></div>
        <div class="layui-col-md11"><p title="{{item}}">{{item}}</p></div>
    </div>
    {{# }) }}
</script>


<!--选择元数据模板-->
<script type="text/html" id="tempContent">
    <div>
        {{# layui.each(d,function(index,item){ }}
        <div>
            <input type="radio" name="temp" value="{{item.id}}">
            <label>{{item.tempname}}</label>
        </div>
        {{#}) }}
        <div class="layui-input-block" style="margin-left: 135px;">
            <button type="button" class="layui-btn" onclick="addTemp()">确定</button>
            <button type="button" class="layui-btn layui-btn-primary" onclick="layer.close();">取消</button>
        </div>
    </div>
</script>

<script type="text/html" id="state1">
    <a>{{d.generatestate == 1 ? "是" : "否"}}</a>
</script>
<script type="text/html" id="toGitHistory">
    <a href="http://47.93.246.70/fastdevplatform/web/commit/{{d.id}}"
       style="color:blue;text-decoration:underline;cusor:pointer;" target="_blank">{{d.title}}</a>
</script>
<script type="text/html" id="site">
    <div class='treeBox' style='margin:15px 35px;border:1px solid #f5f5f5;width:428px;height:317px;'>
        <ul id="treeDemo1" class="ztree" style="width:428px;height:317px;"></ul>
    </div>
    <div class="button-bar">
        <button class="layui-btn" type="button" data-type="generateTpl">确认</button>
        <button class="layui-btn" type="button" data-type="close">取消</button>
    </div>
</script>
<script type="text/html" id="sortTpl">
    <i class="layui-icon sort-icon" data-id="{{d.id}}" data-sort="{{d.fieldorder}}">&#xe65f;</i>
</script>
<script>
    active.mvJar = function () {
        ajax2(service_prefix.generator, "/module/mvnPackage", "post", {}).then(function (res2) {
            if (!res2.success) {
                layer.alert(res2.msg);
                return false;
            }else{
                layer.alert("部署成功!");
            }
        })
    }
    var zTreeObj;
    function getIndex(){
        var curr = getZtreeCurrNode(zTreeObj);
        if(!curr || curr.level==0) return false;
        return curr;
    }
    function zTreeOnClick(event, treeId, treeNode) {
        if(treeNode.level>0){
            doList(1);
        }
    }
    function zTreeBeforeEditName(treeId, treeNode){
        showEditEsLink(treeNode.id);
        return false;
    }
    function zTreeBeforeRemove(treeId, treeNode){
        deleteEsLink(treeNode.id)
        return false;
    }
    function showRemoveAndRenameBtn(treeId, treeNode) {
        if (treeNode.level == 0) {
            return true;
        }
        return false;
    }
    function getMetadatas(pageNo) {
        var jsondata = {
            "pager": {
                "current": pageNo,
                "size": 11,
                sortProps: [{key: "crtime", value: false}]
            }
        }
        ajaxGet("/metadata/es/tree",function(data) {
            if (data.success) {
                for(var o of data.obj){
                    o.icon = 'common/img/u20774.svg';
                    // for(var oo of o.list){
                    //     oo.icon = ''
                    // }
                }
                var settingss = {
                    data: {
                        simpleData: {
                            enable: true, //true 、 false 分别表示 使用 、 不使用 简单数据模式
                            idKey: "id", //节点数据中保存唯一标识的属性名称
                            pIdKey: "parentId", //节点数据中保存其父节点唯一标识的属性名称
                            rootPId: -1 //用于修正根节点父节点数据，即 pIdKey 指定的属性值
                        },
                        key: {
                            children: "list",
                            name: "index"
                        }
                    },
                    edit: {
                        enable: true,//设置是否处于编辑状态        showRemoveBtn: showRemoveAndRenameBtn,
                        showRenameBtn: showRemoveAndRenameBtn,
                        showRemoveBtn: showRemoveAndRenameBtn,
                        removeTitle: "删除",
                        renameTitle: "修改"
                    },
                    view: {
                        showLine: false,
                        showIcon: true
                    },
                    callback: {
                        onClick: zTreeOnClick,
                        beforeEditName: zTreeBeforeEditName,
                        beforeRemove: zTreeBeforeRemove
                    }
                };
                zTreeObj = $.fn.zTree.init($("#treeDemo"), settingss, data.obj); //初始化树
                zTreeObj.expandAll(true); //true 节点全部展开、false节点收缩
                // var node;
                // if (id) {
                //     node = global.zTreeObj.getNodeByParam("id", id);
                // } else {
                //     node = global.zTreeObj.getNodeByTId("treeDemo_3");
                // }
                // lodTpl("leftItemTpl","listForm",data.obj.records);
                // loadPage($.extend({elem:"pageleft",less:true},data.obj),getMetadatas);
                // $(".left-list .jnet-left-item:first").trigger("click");
                // var html = "";
                // for (var i in data.obj.records) {
                //     var obj = data.obj.records[i];
                //     var activeClass = "";
                //     var activeinputc = "";
                //     if (i == 0) {
                //         activeClass = "active";
                //         activeinputc = "checked";
                //     }
                //     html += '<div class="layui-form-item ' + activeClass + '" data_id="' + obj + '" data_name="' + obj + '" pane="">' +
                //         '              <div class="layui-form-label"><input type="radio" name="listid" value="' + obj + '" lay-skin="primary" ' + activeinputc + '>' +
                //         '</div>' +
                //         '              <div class="layui-input-block">' +
                //         '                <p>' + obj + '</p>' +
                //         '              </div>' +
                //         '            </div>';
                // }
                //
                // $("#listForm").html(html);
                layui.form.render();
            }
        });
    }

    function doList(pageNo) {
        var jsondata = {
            "entity": getIndex(),
            "pager": {
                "current": pageNo,
                "size": 14,
                sortProps: [{key: "fieldorder", value: true}, {key: "id", value: true}]
            }
        }
        ajax(service_prefix.metadata, "/es/fieldinfo/list", "post", JSON.stringify(jsondata)).then(function(data) {
            layui.use('table', function () {
                var table = layui.table;
                table.render({
                    elem: '#fieldTabel'
                    , data: data.obj.records
                    , cellMinWidth: 80 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                    , cols: [[
                        {type: 'checkbox'}
                        , {type: 'numbers', title: '序号', width: 50}
                        , {field: 'key', title: '字段'}
                        , {field: 'type', title: '类型'}
                    ]],
                    limit: 1000
                });
            });
        })
    }

    active.createCodes = function () {
        var tableinfo = getIndex();
        if (!tableinfo) {
            layer.alert("请选择ES元数据");
            return false;
        }
        ajaxJsonPost("/generator/module/createEsCode", tableinfo, function(res){
            if (res.success) {
                layer.alert("生成成功！")
            }
        })
    }

    function add() {
        ajax2(service_prefix.metadata, "/dbSource/all", "post", {}).then(function(data) {
            layerOpenTpl("新建ES元数据",500,300,'metadataTemplate',{edit: false,ps:data.obj})
            layui.form.render();
        })
    }

    layui.form.on('submit(addMetadata)', function (data) {
        ajaxJsonPost("/metadata/es/create",data.field,function(res){
            if (res.success) {
                layer.closeAll();
                getMetadatas();
            } else {
                layer.alert(res.msg, function () {
                    layer.closeAll();
                });
            }
        })
        return false;
    });

    function addEsLink() {
        layerOpenTpl("添加ES链接",500,300,"esLinkTpl",{})
    }

    function showEditEsLink(id){
        ajaxGet("/metadata/dbSource/"+id,function(data){
            layerOpenTpl("添加ES链接",500,300,"esLinkTpl")
            layui.form.val("esLinkForm",data.obj)
        })
    }

    function deleteEsLink(id){
        ajaxGet("/metadata/dbSource/delete/"+id,function(data){
            getMetadatas();
        })
    }

    layui.form.on('submit(addDbSource)', function (data) {
        ajaxJsonPost("/metadata/dbSource"+(data.field.id?"/"+data.field.id:""),data.field,function(res){
            if (res.success) {
                layer.closeAll();
                getMetadatas();
            } else {
                layer.alert(res.msg, function () {
                    layer.closeAll();
                });
            }
        })
        return false;
    });


    function del() {
        var data = getIndex();
        if(!data) {
            layer.alert("请选择ES元数据");
            return false;
        }
        layer.open({
            content: "确认删除该ES元数据吗？"
            , btn: ['确认', "取消"]
            , yes: function (index, layero) {
                ajaxJsonPost("/metadata/es/delete", data,function(data) {
                    if (data.success) {
                        getMetadatas();
                        layer.close(index);
                        // ajax(service_prefix.log, "/metadata", "post", JSON.stringify({
                        //     handleType: "删除ES元数据",
                        //     name: tablename,
                        // })).then(function (data) {
                        //     if (data.success) {
                        //
                        //     }
                        // });
                    } else {
                        layer.alert(data.msg);
                    }
                })
            }
            , btn2: function (index, layero) {
                layer.closeAll();
            }
        });
    }

    active.addEsField = function () {
        layerOpen("添加字段", 550, 780);
        lodTpl("fieldTemplate", "openDiv", getZtreeCurrNode(zTreeObj), function () {
            // layui.form.val("fieldForm", {tableid: metadataObj.id, tablename: metadataObj.name});
        })
    };



    form.on('submit(addEsFieldinfo)', function (data) {
        // data.showDetail = data.showDetail == "on" ? 1 : 0;
        // data.showList = data.showList == "on" ? 1 : 0;
        // data.showSearch = data.showSearch == "on" ? 1 : 0;
        // data.issort = data.issort == "on" ? 1 : 0;
        // if(data.fieldtype == 4) data.dblength = data.dblength == "on" ? 1 : 0;
        // var dbtype = $("#fieldtype").find("option:selected").attr("dbtype")
        // if (dbtype < 0) data.dbtype = dbtype;
        ajax(service_prefix.metadata, "/es/addField", "POST", JSON.stringify(data.field)).then(res => {
            if (res.success) {
                doList(1);
                layer.closeAll();
            } else {
                layer.alert(res.msg ? res.msg : "添加失败");
            }
        })
        return false;
    });

    function saveToDb(){
        ajaxGet("/metadata/es/saveToDb",function(data){
            if(data.success){
                layer.alert("保存成功!");
            }
        })
    }

    $(function () {
        $(".left-list").on("mouseover", ".jnet-left-item", function () {
            $(this).addClass("active2").siblings().removeClass("active2");
        })
        $(".left-list").on("mouseleave", ".jnet-left-item", function () {
            $(this).removeClass("active2");
        })
        $(".left-list").on("click", ".jnet-left-item", function () {
            var createdTime = $(this).attr("created_data_time");
            var generatedTime = $(this).attr("generated_data_time");
            var cruser = $(this).attr("created_user")
            $(".createddataTime").html("创建时间："+createdTime)
            $(".generatedataTime").html("生成时间："+generatedTime)
            $(".founder").html("创建人：" + cruser)
            $(".describe").html("描述：")

            $(".left-list input").prop("checked", false);
            $(this).find("input").prop("checked", true);
            layui.form.render();
            $(this).addClass("active").siblings().removeClass("active");
            doList(1);
        })
        layui.form.render();
        getMetadatas(1);
    })
</script>
