<title>元数据分组管理</title>

<style>
  .addColor {
    background: rgba(218, 250, 162, 1)
  }

  .left-list .layui-form-label {
    padding: 0px;
    width: auto;
  }

  .left-list .layui-input-block {
    margin-left: 20px;
    line-height: 33px;
  }

  .left-list .layui-form-item .layui-form-checkbox[lay-skin=primary] {
    margin-top: 5px;
  }

  .left-list .layui-form-item .layui-form-radio {
    margin: 2px -8px 0 0;
  }

  .left-list .active {
    background: rgba(218, 250, 162, 1)
  }

  .left-list .active2 {
    background: rgba(218, 250, 162, 1)
  }

  .left-list .layui-card-body {
    padding: 10px 0;
    height: 75%;
  }

  .left-list .layui-form-item {
    padding: 5px 10px;
    margin-bottom: 0px;
    cursor: pointer;
  }

  .left-list .layui-btn-container {
    padding-left: 25px;
  }

  li .layui-form-checkbox[lay-skin=primary] div span:nth-of-type(1) {
    width: 80px;
  }

  li .layui-form-checkbox[lay-skin=primary] div span:nth-of-type(2) {
    width: 80px;
    margin-left: 45px;
  }

  #fieldPage {
    position: absolute;
    bottom: 8px;
  }

  .layui-card-body {
    height: 88%;
  }

  .k_btnRight {
    float: right;
  }

  .k_btnLeft {
    float: left;
  }

  .k_TitleCreatedtime {
    display: flex;
    justify-content: space-between;
    border-bottom: 1px solid #f6f6f6
  }

  .k_TitleCreatedtime .k_Title {
    border-bottom: none;
  }

  .k_TitleCreatedtime .createdTime {
    padding: 0 15px;
    height: 42px;
    line-height: 42px;
  }

  .tipsContent {
    width: 180px;
    display: none;
    background-color: #7c7979;
    color: #fff;
    position: absolute;
    top: 20px;
    left: 95%;
    z-index: 100;
    border-radius: 3px;
    padding: 10px;
  }
</style>

<div class="layui-fluid">
  <div class="layui-col-md3 md3-left left-list h100">
    <div class="layui-card h100">
      <div class="layui-card-header">分组
        <div class="layui-btn-container" style="float: right;">
          <button type="button" class="layui-btn layui-btn-sm allButton k_secondBtn" title="新建分组"
            style="background: url(common/img/icon/u13151.svg) no-repeat center;" data-type="add"></button>
          <button type="button" class="layui-btn layui-btn-sm allButton k_secondBtn" title="修改分组"
            style="background: url(common/img/icon/u13153.svg) no-repeat center;" data-type="edit"></button>
          <button type="button" class="layui-btn layui-btn-sm allButton k_secondBtn" title="删除分组"
            style="background: url(common/img/icon/u13152.svg) no-repeat center;" data-type="delGroup"></button>
        </div>

      </div>
      <div class="layui-card-body" style="overflow:auto;">
        <!-- <div class="layui-btn-container">
          <button type="button" class="layui-btn layui-btn-sm allButton" data-type="add"><i class="layui-icon">&#xe608;</i> <span style="display: none;">新建分组</span></button>
          <button type="button" class="layui-btn layui-btn-sm allButton" data-type="edit"><i class="layui-icon">&#xe642;</i> <span style="display: none;">修改分组</span></button>
          <button type="button" class="layui-btn layui-btn-sm allButton" data-type="delGroup"><i class="layui-icon">&#xe640;</i> <span style="display: none;">删除分组</span></button>
        </div> -->
        <form class="layui-form" action="" id="listForm" style='position: relative;'>
        </form>
      </div>
      <div class="" id="pageleft" style="padding-left: 10px"></div>
    </div>
  </div>
  <div class="layui-col-md9 md3-right h100">
    <div class="layui-card h100">
      <div class="k_TitleCreatedtime">
        <div class="layui-card-header k_Title">子分组
          <button type="button" class="layui-btn layui-btn-sm allButton k_secondBtn tipsText" title="提示信息"
            style="background: url(common/img/icon/u12898.svg) no-repeat center;margin-left: 2px !important;"></button>
          <div class="tipsContent">
            <p class="createdTime" style="line-height: 25px; height: 25px;padding: 0;"></p>
            <p class="founder" style="line-height: 25px;"></p>
            <p class="describe" style="line-height: 25px;">描述：这是一段描述</p>
          </div>
        </div>
        <div class="createdTime" id="createdTime"></div>
      </div>
      <div class="layui-card-body">
        <div class="k_searchBtn">
          <div class="layui-btn-container k_btnLeft">
            <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" data-type="add2">新建子分组</button>
            <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" data-type="edit2">修改子分组</button>
            <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" data-type="del">删除子分组</button>
          </div>
          <div class=" k_btnRight">
            <form class="layui-form" action="" style="display: inline-block;float: left;">
              <input type="text" name="title" placeholder="请输入子分组名称" autocomplete="off" class="layui-input search-input"
                id="val">
              <button class="layui-btn" type="button" style="padding: 0 10px;margin-left: 8px;" lay-submit
                lay-filter="anothernameSearch" onclick="getTables1()"><i class="layui-icon">&#xe615;</i></button>
              <button type="button" class="layui-btn layui-btn-sm layui-inline layui-btn-primary" onclick="showSearchBody()"><img src="common/img/u11999.svg"></button>
            </form>
          </div>
        </div>


        <div class="table-area-mini">
          <table class="layui-hide" id="fieldTabel"></table>
          <div id="fieldPage"></div>
        </div>

      </div>
    </div>
    <div class="layui-card jnet-search-body">
        <div class="layui-card-header"><div class="layui-col-md5">筛选</div><div class="layui-col-md7"><img onclick="closeSearchBody()" src="common/img/u11915.svg" style="float: right; margin-top: 15px;cursor: pointer;"></div></div>
        <div class="layui-card-body">
           <form class="layui-form">
               <div class="layui-row">
                   子分组名称
               </div>
               <div class="layui-row">
                   <input class="layui-input" type="text" name="name">
               </div>
               <div class="layui-row">
                   描述
               </div>
               <div class="layui-row">
                   <input class="layui-input" type="text" name="groupdesc">
               </div>
               <div class="layui-row">
                   创建人
               </div>
               <div class="layui-row">
                   <input class="layui-input" type="text" name="crUser">
               </div>
               <div class="layui-row">
                   创建时间
               </div>
               <div class="layui-row">
                   <input class="layui-input jnet-search-crtime" type="text" name="createTime">
               </div>
               <div class="jnet-submit-bar">
                    <button class="layui-btn layui-btn-sm" lay-submit lay-filter="searchTable">确定</button>
                    <button type="reset" class="layui-btn layui-btn-primary layui-btn-sm">重置</button>
               </div>
           </form>
        </div>
    </div>
  </div>
</div>
<!--弹出层模板（新增，查看，编辑）-->
<script type="text/html" id="dataFormTpl">
  <form class="layui-form" lay-filter="dataForm">
    <div class="layui-card">
      <div class="layui-card-body">
        <div class="layui-form-item">
          <label class="layui-form-label">分组名称:</label>
          <div class="layui-input-block">
            <input type="text" name="name" value="" required lay-verify="required" placeholder="请输入" autocomplete="off"
              class="layui-input">
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">分组描述:</label>
          <div class="layui-input-block">
            <input type="text" name="groupdesc" value="" required lay-verify="required" placeholder="请输入"
              autocomplete="off" class="layui-input">
          </div>
        </div>
      </div>
    </div>
    <input type="hidden" name="parentid" />
    <input type="hidden" name="id" />
    <div class="button-bar">
      <button class="layui-btn" lay-submit lay-filter="addData">确认</button>
      <button class="layui-btn" type="button" data-type="close">取消</button>
    </div>
  </form>
</script>

<script>
  //button划入划出事件
  $(".allButton").hover(function () {
    // console.log($(this))
    $(this).children().next().show()
  }, function () {
    $(this).children().next().hide()
  });

  $(function () {
    $(".left-list").on("mouseover", ".layui-form-item", function () {
      $(this).addClass("active2").siblings().removeClass("active2");
    })
    $(".left-list").on("mouseleave", ".layui-form-item", function () {
      $(this).removeClass("active2");
    })
    $(".left-list").on("click", ".layui-form-item", function () {

      var createdTime = $(this).attr("created_data_time");
      var cruser = $(this).attr("created_user");

      $(".createdTime").html("创建时间：" + createdTime);
      $(".founder").html("创建人：" + cruser)

      $(".left-list input").prop("checked", false);
      $(this).find("input").prop("checked", true);
      layui.form.render();
      $(this).addClass("active").siblings().removeClass("active");
      groupObj.id = $(this).attr("data_id");
      groupObj.name = $(this).attr("data_name");
      getChildGroup($(this).attr("data_id"), 1);
    })
    layui.form.render();
    getGroups(1);
  })

  var groupObj = {};

  function getGroups(pageNo) {
    var jsondata = {
      "pager": {
        "current": pageNo,
        "size": 10
      },
      "entity": {
        "parentid": 0
      }
    }
    ajax(service_prefix.metadata, "/group/list", "post", JSON.stringify(jsondata)).then(data => {
      console.log(data);
      if (data.success) {
        if (data.obj.records.length > 0) {
          getChildGroup(data.obj.records[0].id, 1);
          groupObj.id = data.obj.records[0].id;
          groupObj.name = data.obj.records[0].name;
        }
        var html = "";
        for (var i in data.obj.records) {
          var obj = data.obj.records[i];
          var activeClass = "";
          var activeinputc = "";
          if (i == 0) {
            activeClass = "active";
            activeinputc = "checked";
          };
          html += '<div class="layui-form-item ' + activeClass + '" created_user="' + obj.crUser + '" data_id="' +
            obj.id + '" created_data_time="' +
            obj.createTime.substr(0, 10) + '"  data_desc="' + obj.groupdesc + '" data_name="' + obj.name +
            '" pane="">' +
            '              <div class="layui-form-label"><input type="radio" name="listidg" value="' + obj.id +
            '" lay-skin="primary" ' + activeinputc + '></div>' +
            '              <div class="layui-input-block">' +
            '                <p>' + obj.name + '</p>' +
            // '                <p>创建时间:' + obj.createTime.substr(0, 10) + '</p>' +
            '              </div>' +
            '            </div>';
        };

        $(".founder").html("创建人：" + data.obj.records[0].crUser)
        $(".createdTime").html("创建人："  + data.obj.records[0].crUser + '&nbsp;&nbsp;&nbsp;&nbsp;创建时间：' + data.obj.records[0].createTime.substr(0, 16) )
        $("#listForm").html(html);
        var laypage = layui.laypage,
          layer = layui.layer;
        layui.use(['laypage', 'layer'], function () {
          laypage.render({
            elem: 'pageleft',
            count: data.obj.total //数据总数
              ,
            curr: data.obj.current,
            prev: '<i class="layui-icon">&#xe603;</i>',
            next: '<i class="layui-icon">&#xe602;</i>',
            jump: function (obj, first) {
              if (!first) {
                getGroups(obj.curr)
              }
            }
          });
        });

        layui.form.render();
      }
    })
  }
  function showSearchBody(){
      $(".jnet-search-body").show();
  }
  function closeSearchBody(){
      $(".jnet-search-body").hide();
  }

  layui.laydate.render({
      elem: '.jnet-search-crtime'
      , range: true
  });
  function getChildGroup(id, pageno,name,groupdesc,crUser,createTime,createTimeto) {
    var jsondata = {
      "entity": {
        "parentid": id,
          "name"  :name,
          "groupdesc":groupdesc,
          "crUser"  :crUser,
          "createTime"  :createTime,
          "createTimeto"  :createTimeto,
      },
      "pager": {
        "current": pageno,
        "size": 15
      }
    }


    ajax(service_prefix.metadata, "/group/list", "post", JSON.stringify(jsondata)).then(data => {
      console.log(data);

      layui.use('table', function () {
        var table = layui.table;
        table.render({
          elem: '#fieldTabel',
          data: data.obj.records,
          cellMinWidth: 80 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            ,
          cols: [
            [{
              type: 'checkbox'
            }, {
              type: 'numbers',
              title: '序号',
              width: 60
            }, {
              field: 'name',
              title: '子分组名称',
              width: 150
            }, {
              field: 'groupdesc',
              title: '描述',
            }, {
              field: 'crUser',
              title: '创建人',
              width: 80
            }, {
              field: 'createTime',
              title: '创建时间',
              sort: true,
              width: 165
            }]
          ],
          id: "demo2",
          limit: 15
        });
      });
      layui.laypage.render({
        elem: 'fieldPage',
        count: data.obj.total //数据总数
          ,
        curr: data.obj.current,
        limit: 15,
        jump: function (obj, first) {
          if (!first) {
            getChildGroup(groupObj.id, obj.curr);
          }
        }
      });
    })
  }
  var obj ={};
  layui.form.on("submit(searchTable)",function(data){
      var time = data.field.createTime;
      if(time){
          var times = time.split(" - ");
          data.field.createTimeto = times[1];
          data.field.createTime = times[0];
          obj = data.field;
      }else {
          obj = data.field;
      }
      var id =  groupObj.id ;
      var name = obj.name;
      var groupdesc = obj.groupdesc;
      var crUser = obj.crUser;
      var createTime = obj.createTime;
      var createTimeto = obj.createTimeto;
      getChildGroup(id,1,name,groupdesc,crUser,createTime,createTimeto);
      return false;
  })


  function getTables1() {

       var id =  groupObj.id ;
       var name = $("#val").val()

       getChildGroup(id,1,name)

      }




  var defaultSize = 15;

  function add() {
    showData({
      parentid: 0
    });
  }

  active.add2 = function () {
    showData({
      parentid: groupObj.id,
      parentName: groupObj.name
    });
  }

  function showData(data) {
    console.log(data);
    var dataTitle;
    if (data.id && data.parentid == 0) {
      dataTitle = "修改分组"
    } else if (data.id && data.parentid != 0) {
      dataTitle = "修改子分组";
    } else if (!data.id && data.parentid == 0) {
      dataTitle = "新建分组";
    } else {
      dataTitle = "新建子分组";
    }
    //多窗口模式，层叠置顶
    layer.open({
      type: 1,
      title: dataTitle,
      area: ['600px', '250px'],
      maxmin: true,
      content: '<div id="dataFormDiv"></div>',
    });
    layui.laytpl($("#dataFormTpl").html()).render({}, function (html) {
      $("#dataFormDiv").html(html)
    });
    layui.form.val("dataForm", data);
  }

  layui.form.on("submit(addData)", function (data) {
    console.log(data);
    if (data.field.id && data.field.parentid == 0) {
      doEditGroup(data.field);
    } else if (data.field.id && data.field.parentid != 0) {
      doEditGroupT(data.field);
    } else if (data.field.parentid != 0) {
      ajax(service_prefix.metadata, "/group", "post", JSON.stringify(data.field)).then(res => {
        if (res.success) {
          getChildGroup(groupObj.id, 1);
          layer.closeAll();
        } else {
          layer.alert(res.msg);
        }
      })
      return false;
    } else {
      ajax(service_prefix.metadata, "/group", "post", JSON.stringify(data.field)).then(res => {
        if (res.success) {
          getGroups(1);
          layer.closeAll();
        } else {
          layer.alert(res.msg);
        }
      })
      return false;
    }
    return false;
  })

  function doEditGroup(data) {
    ajax(service_prefix.metadata, "/group/" + data.id, "put", JSON.stringify(data)).then(res => {
      if (res.success) {
        layer.closeAll();
        getGroups(1);
      } else {
        layer.alert(res.msg, function () {
          layer.closeAll();
        });
      }
    })
  }

  function doEditGroupT(data) {
    ajax(service_prefix.metadata, "/group/" + data.id, "put", JSON.stringify(data)).then(res => {
      if (res.success) {
        layer.closeAll();
        getChildGroup(groupObj.id, 1);
      } else {
        layer.alert(res.msg, function () {
          layer.closeAll();
        });
      }
    })
  }

  active.delGroup = function () {
    delGroupA();
  };

  function delGroupA() {
    var ids = [];
    $("input[name='listidg']:checked").each(function () {
      ids.push($(this).val());
    })
    console.log(ids)
    if (ids.length <= 0) {
      layer.alert("请选择分组");
      return false;
    }
    layer.open({
      content: "确认删除该分组吗？",
      btn: ['确认', "取消"],
      yes: function (index, layero) {
        for (var i in ids) {
          var jsondata = {
            "entity": {
              "parentid": ids[i]
            },
            "pager": {
              "current": 1,
              "size": 100
            }
          }
          ajax(service_prefix.metadata, "/group/list", "post", JSON.stringify(jsondata)).then(data => {
            var dids = [];
            for (var i = 0; i < data.obj.records.length; i++) {
              dids.push(data.obj.records[i].id);
            }
            ajax(service_prefix.metadata, "/group/delByIds", "post", JSON.stringify(dids)).then(data => {});
          });
        }
        ajax(service_prefix.metadata, "/group/delByIds", "post", JSON.stringify(ids)).then(data => {
          if (data.success) {
            getGroups(1);
            getChildGroup(groupObj.id, 1);
          } else {
            layer.alert(data.msg);
          }
          layer.closeAll();
        }).catch(res => {

        })
      },
      btn2: function (index, layero) {
        layer.closeAll();
      }
    });

  }

  function del() {
    var data2 = layui.table.checkStatus('demo2');
    var ids = [];
    for (var i = 0; i < data2.data.length; i++) {
      ids.push(data2.data[i].id);
    }
    if (ids.length <= 0) {
      layer.alert("请选择子分组");
      return false;
    }
    layer.open({
      content: "确认删除该子分组吗？",
      btn: ['确认', "取消"],
      yes: function (index, layero) {
        ajax(service_prefix.metadata, "/group/delByIds", "post", JSON.stringify(ids)).then(data => {
          if (data.success) {
            getChildGroup(groupObj.id, 1);
            layer.close(index);
          } else {
            layer.alert(data.msg);
          }
        }).catch(res => {

        })
      },
      btn2: function (index, layero) {
        layer.closeAll();
      }
    });
  }

  function checkChoice() {
    if (!groupObj.id) {
      layer.alert("请选择菜单");
      return false;
    }
    return true;
  }

  function edit() {
    if (checkChoice()) {
      var jsondata = {
        "pager": {
          "current": 1,
          "size": 10
        },
        "entity": {
          "id": groupObj.id
        }
      }
      ajax(service_prefix.metadata, "/group/list", "post", JSON.stringify(jsondata)).then(data => {
        layer.open({
          type: 1,
          title: "修改分组",
          area: ['600px', '250px'],
          maxmin: true,
          content: '<div id="dataFormDiv"></div>',
        });
        layui.laytpl($("#dataFormTpl").html()).render({}, function (html) {
          $("#dataFormDiv").html(html)
        });
        layui.form.val("dataForm", data.obj.records[0]);
      })
    }
  }
  active.edit2 = function () {
    editT2();
  }

  function editT2() {
    var dataEdit = layui.table.checkStatus('demo2');
    var ids = [];
    for (var i = 0; i < dataEdit.data.length; i++) {
      ids.push(dataEdit.data[i].id);
    }
    if (ids.length <= 0) {
      layer.alert("请选择子分组");
      return false;
    } else if (ids.length > 1) {
      layer.alert("请选择一条数据进行修改！");
      return false;
    }
    var jsondata = {
      "pager": {
        "current": 1,
        "size": 100
      },
      "entity": {
        "id": ids[0]
      }
    }
    ajax(service_prefix.metadata, "/group/list", "post", JSON.stringify(jsondata)).then(data => {
      layer.open({
        type: 1,
        title: "修改子分组",
        area: ['600px', '250px'],
        maxmin: true,
        content: '<div id="dataFormDiv"></div>',
      });
      layui.laytpl($("#dataFormTpl").html()).render({}, function (html) {
        $("#dataFormDiv").html(html)
      });
      layui.form.val("dataForm", data.obj.records[0]);
    })

  }

  // kang
  // 显示隐藏提示信息
  $(".tipsText").click(function () {
    $(".tipsContent").toggle();
  })

  // 显示隐藏筛选条件
  active.screen = function () { 
        layer.open({
            type: 1,
            title: "筛选",
            area: ['35%', '35%'],
            maxmin: true,
            content: '<div id="screenModuleinfo"></div>',
        });
        layui.laytpl($("#screenTemplate").html()).render({}, function (html) {
            $("#screenModuleinfo").html(html);
        });
    }


</script>

<!-- 右侧筛选条件模板 -->
<script type="text/html" id="screenTemplate">
  <form class="layui-form" lay-filter="moduleinfoForm">
      <div class="layui-card">
          <div class="layui-card-body" style="padding:25px 45px;">
              <div class="layui-form-item">
                  <label class="layui-form-label">中文名称:</label>
                  <div class="layui-input-block">
                      <input type="text" name="anothername" value="" required lay-verify="required"
                          autocomplete="off" class="layui-input">
                  </div>
              </div>
              <div class="layui-form-item">
                  <label class="layui-form-label">英文名称:</label>
                  <div class="layui-input-block">
                      <input type="text" name="englishname" value="" required lay-verify="required"
                          autocomplete="off" class="layui-input">
                  </div>
              </div>
              <div class="layui-form-item">
                  <label class="layui-form-label">引入人:</label>
                  <div class="layui-input-block">
                      <input type="text" name="modulename" value="" required lay-verify="required"
                          autocomplete="off" class="layui-input">
                  </div>
              </div>
              <div class="layui-form-item">
                  <label class="layui-form-label">引入时间:</label>
                  <div class="layui-input-block">
                      <input type="text" name="moduledata" value="" required lay-verify="required"
                          autocomplete="off" class="layui-input">
                  </div>
              </div>
              <div class="layui-form-item">
                  <div class="layui-input-block" style="margin-left: 175px;">
                      <button class="layui-btn" lay-submit lay-filter="addModuleinfo">确认</button>
                      <button type="reset" class="layui-btn layui-btn-primary" >重置</button>
                      <!-- <button type="button" class="layui-btn layui-btn-primary"
                          onclick="layer.closeAll();">取消</button> -->
                  </div>
              </div>
          </div>
      </div>
      <input type="hidden" name="id" />
  </form>
</script>